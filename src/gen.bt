// SPDX-FileCopyrightText: 2023-present Lukas Neubert <lukas.neubert@proton.me>
// SPDX-License-Identifier: MPL-2.0
package main

fun generate(mod Module, table Table) string {
	mut g := Gen{
		table = table
	}
	return g.gen(mod)
}

struct Gen {
mut:
	table Table
	mod_name string
	out string
}

fun (mut g Gen) gen(mod Module) string {
	g.out += 'package ' + mod.name + '\n\n'
	g.out += "import '${mod.name}' as #JS.${mod.name}\n\n"

	g.mod_name = '#JS.' + mod.name
	g.decls(mod.decls)

	return g.out
}

fun (mut g Gen) decls(decls []Decl) {
	for decl in decls {
		g.decl(decl)
	}
}

fun (mut g Gen) decl(decl Decl) {
	match decl {
		Const {
			g.const_decl(decl)
		}
		Interface {
			g.interface_decl(decl)
		}
		else {
			panic('cannot gen ${decl}')
		}
	}
}

fun (mut g Gen) const_decl(decl Const) {
	g.out += 'pub const ${g.mod_name}.${decl.name} := ${g.typ(decl.typ)}\n\n'
}

fun (mut g Gen) interface_decl(decl Interface) {
	g.out += 'pub interface ${g.mod_name}.${decl.name}{\n'
	// g.out += 'pub:\n'
	g.fields(decl.fields)
	g.out += '}\n\n'
}

fun (mut g Gen) fields(fields []Field) {
	for field in fields {
		g.field(field)
	}
}

fun (mut g Gen) field(field Field) {
	// TODO
}

fun (mut g Gen) typ(typ i32) string {
	return g.table.syms[typ].name
}
